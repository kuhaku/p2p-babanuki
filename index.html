<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ババ活 (P2P ババ抜き)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Tone.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="babanuki.js"></script>
    <style>
        /* フォント設定 */
        body {
            font-family: "MS Gothic", "Inter", "Hiragino Kaku Gothic ProN", sans-serif;
            color: white;
        }

        /* カードのスタイル */
        .card {
            width: clamp(60px, 18vw, 100px);

            aspect-ratio: 2 / 3;

            border: 2px solid #333;
            border-radius: 8px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;

            /* フォントサイズも clamp() でレスポンシブにします */
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            margin: 4px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .card.joker {
            font-size: clamp(1.0rem, 3.5vw, 1.5rem);
        }

        .card-back {
            /* 1. ベースの黄色 */
            background-color: #FAD544;

            /*
            * 2. ギザギザ模様
            */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 20'%3E%3Cpath d='M 0 5 L 10 0 L 20 5 L 30 0 L 40 5 L 40 10 L 30 5 L 20 10 L 10 5 L 0 10 Z' fill='black' /%3E%3C/svg%3E");
            /* 3. 繰り返し方法 (横方向(x)にのみリピート) */
            background-repeat: repeat-x;

            /* 4. 表示位置 */
            background-position: center 85%;

            /*
            * 5. 模様のサイズ
            */
            background-size: 60px 30px;

            /* カードの文字を非表示にする */
            color: transparent;
        }

        /* 赤いカード（ダイヤとハート） */
        .card.red {
            color: #E53E3E;
        }

        /* モーダル */
        #modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>

<body class="text-gray-800 w-full" style="background-color: #004040;">

    <div id="app" class="container min-h-screen mx-auto md:mx-4 sm:mx-1 w-full">

        <!-- 画面 1: 名前入力 & 接続 -->
        <div id="setup-screen" class="p-6">
            <h1 class="text-2xl font-bold mb-6 text-center text-white">ババ活 (P2P ババ抜き)</h1>

            <div class="mb-4">
                <label for="name-input" class="block text-sm font-medium text-white mb-1">貴殿の名前:</label>
                <input type="text" id="name-input"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                    placeholder="プレイヤー名">
            </div>

            <button id="join-lobby-btn"
                class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                待合室に入る
            </button>
            <div id="setup-loading" class="hidden text-center mt-4">
                <p class="text-green-600 animate-pulse">Supabaseに接続中...</p>
            </div>
        </div>

        <!-- 画面 2: ロビー -->
        <div id="lobby-screen" class="hidden p-6">
            <div class="md:flex md:justify-between lg:items-center mb-6">
                <div class="flex justify-between items-center mb-4 md:mb-0">
                    <h2 class="text-2xl font-bold text-white">ババ活待合室</h2>
                    <!-- 低解像度用退出ボタン (mdで非表示) -->
                    <button
                        class="bg-gray-400 text-white font-semibold py-1 px-3 rounded-lg shadow hover:bg-gray-500 text-sm whitespace-nowrap md:hidden"
                        onclick="leaveLobby();">
                        退出
                    </button>
                </div>

                <div class="md:flex md:items-center md:justify-end md:space-x-4">
                    <p id="user-name" class="text-white text-left lg:text-base text-xs whitespace-nowrap">名前:
                    </p>
                    <!-- 高解像度用退出ボタン (md未満で非表示) -->
                    <button
                        class="hidden bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-500 whitespace-nowrap md:block"
                        onclick="leaveLobby();">
                        退出
                    </button>
                </div>
            </div>
            <div class="md:grid md:grid-cols-2 md:gap-6">
                <!-- 左カラム: プレイヤーリスト -->
                <div>
                    <p class="mb-4 text-white">ババ活相手を選んでください</p>
                    <p id="no-players-message" class="hidden font-semibold text-yellow-300 text-center my-2">
                        誰もいません(^Д^)
                    </p>
                    <p id="no-players-image" class="hidden flex justify-center">
                    </p>
                    <div id="player-list" class="space-y-3">
                        <!-- プレイヤーリストがここに入る -->
                    </div>
                </div>

                <!-- 右カラム: ロビーチャット -->
                <div id="lobby-chat" class="md:border-none border-t border-gray-300 md:my-0 my-2">
                    <h3 class="text-xl font-semibold text-white mb-2">待合室チャット</h3>
                    <div id="chat-messages"
                        class="bg-green-950 h-64 overflow-y-auto rounded-md p-3 mb-3 text-sm shadow-lg">
                    </div>
                    <div class="flex justify-between items-center md:space-x-2 space-x-1">
                        <input id="chat-input" type="text" placeholder="メッセージを入力"
                            class="flex flex-grow border border-gray-300 rounded-md md:px-3 px-1 py-2 focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <button id="chat-send-btn"
                            class="flex flex-nowrap bg-green-600 text-white font-bold md:text-base text-xs md:px-4 px-1 py-2 rounded-md hover:bg-green-700 transition">投稿</button>
                        <button id="flex chat-input-clear-btn"
                            class="flex-nowrap bg-green-800 text-white font-semibold md:text-base text-xs md:px-4 px-1 py-2 rounded-lg shadow hover:bg-green-900 transition"
                            onclick="document.getElementById('chat-input').value = '';">消す</button>
                    </div>
                    <div class="my-2 flex justify-center">
                        <button id="gyou-button"
                            class="hidden bg-red-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-red-950 active:bg-white active:text-red-950 transition"
                            onclick="gyouzaNoOhSho();">餃</button>
                        <button id="za-button"
                            class="hidden bg-red-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-red-950 active:bg-white active:text-red-950 transition"
                            onclick="gyouzaNoOhSho();">子</button>
                        <button id="no-button"
                            class="hidden bg-red-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-red-950 active:bg-white active:text-red-950 transition"
                            onclick="gyouzaNoOhSho();">の</button>
                        <button id="oh-button"
                            class="hidden bg-red-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-red-950 active:bg-white active:text-red-950 transition"
                            onclick="gyouzaNoOhSho();">王</button>
                        <button id="sho-button"
                            class="bg-red-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-red-950 active:bg-white active:text-red-950 transition"
                            onclick="gyouzaNoOhSho();">将</button>
                    </div>
                </div>
                <p><span class="bg-sky-600 text-white rounded-md p-2 mx-2"><a
                            href="https://x.com/intent/post?text=%E3%83%90%E3%83%90%E6%B4%BB%E7%9B%B8%E6%89%8B%E5%8B%9F%E9%9B%86%E4%B8%AD%28%3B%C2%B4%D0%94%60%29%20%0Ahttps%3A%2F%2Fkuhaku.github.io%2Fp2p-babanuki%2F%0A%23%E3%83%90%E3%83%90%E6%B4%BB%20%23%E5%90%88%E6%B3%95%20%23%E3%83%84%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%20%23%E7%A7%98%E5%AF%86%20%23%E5%85%B1%E6%9C%89">ツイッター</a></span>
                    <span class="bg-green-700 text-white rounded-md p-2 mx-2"><a
                            href="https://social-plugins.line.me/lineit/share?url=https%3A%2F%2Fkuhaku.github.io%2Fp2p-babanuki%2F">LINE</a></span>
                </p>
            </div>
        </div>

        <!-- 画面 3: ゲーム画面 -->
        <div id="game-screen" class="hidden" style="background-color: #004040;">
            <div class="flex justify-between items-center mt-2 mb-2">
                <h2 id="status-message" class="text-2xl font-bold text-white">接続待機中...</h2>
                <button id="leave-game-btn"
                    class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-700 transition duration-300">
                    ババ活終了
                </button>
            </div>

            <div class="md:grid md:grid-cols-2 gap-6">
                <div>
                    <!-- 相手の手札 -->
                    <div class="mb-4 p-2 bg-green-800 rounded-lg shadow-lg">
                        <h3 id="opponent-name" class="text-white lg:text-lg font-semibold mb-2 text-center">敵</h3>
                        <div id="opponent-hand-container" class="flex flex-wrap justify-center min-h-[130px]">
                            <!-- 相手のカード（裏）がここに入る -->
                        </div>
                    </div>

                    <!-- 引いたカード情報 (自分のみ表示) -->
                    <div id="drawn-card-message"
                        class="text-center text-yellow-300 md:text-lg font-semibold my-2 min-h-[25px]">
                        <!-- 引いたカードのメッセージがここに入る -->
                    </div>

                    <!-- 自分の手札 -->
                    <div class="mt-4 p-2 bg-green-800 rounded-lg shadow-lg">
                        <h3 id="my-name" class="text-white md:text-lg font-semibold mb-2 text-center">自分</h3>
                        <div id="my-hand-container" class="flex flex-wrap justify-center min-h-[130px]">
                            <!-- 自分のカードがここに入る -->
                        </div>
                    </div>
                </div>

                <!-- 対戦部屋チャット -->
                <div>
                    <div>
                        <h3 class="md:text-lg font-semibold text-white mb-2">対戦部屋チャット</h3>
                        <div class="my-2 flex justify-center md:block">
                            <button
                                class="bg-red-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-red-950 active:bg-white active:text-red-950 transition"
                                onclick="sendReaction('ヽ(;`Д´)ﾉ');">ヽ(;`Д´)ﾉ</button>
                            <button
                                class="bg-green-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-green-950 active:bg-white active:text-green-950 transition"
                                onclick="sendReaction('(;´Д`)');">(;´Д`)</button>
                            <button
                                class="bg-yellow-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-yellow-950 active:bg-white active:text-yellow-950 transition"
                                onclick="sendReaction('ヽ(´ー｀)ノ');">ヽ(´ー｀)ノ</button>
                            <button
                                class="bg-orange-900 text-white font-bold lg:text-base md:text-sm text-xs md:mx-3 mx-1 md:px-2 px-1 py-1 rounded-md hover:bg-orange-950 active:bg-white active:text-orange-950 transition"
                                onclick="sendReaction('(^Д^)');">(^Д^)</button>
                        </div>
                        <div id="game-chat-messages"
                            class="bg-green-950 h-48 overflow-y-auto rounded-md p-3 mb-3 text-sm shadow-lg">
                        </div>
                        <div class="flex space-x-2">
                            <input id="game-chat-input" type="text" placeholder="メッセージを入力"
                                class="flex-grow border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <button id="game-chat-send"
                                class="bg-green-600 text-white font-bold px-4 py-2 rounded-md hover:bg-green-700 transition"
                                onclick="sendGameChatMessage();">投稿</button>
                            <button id="game-chat-input-clear-btn"
                                class="bg-green-800 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-green-900 transition"
                                onclick="document.getElementById('game-chat-input').value = '';">消す</button>
                        </div>
                        <div id="file-transfer-container" class="md:text-base font-semibold text-white mb-2 py-2">
                            <h4 class="text-base text-white font-semibold mb-2">ファイルを送る</h4>
                            <div class="flex justify-between items-center space-x-1">
                                <input type="file" id="file-input"
                                    class="text-white text-sm file:mr-2 file:py-1 file:px-1 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 w-full"
                                    disabled>
                                <button id="file-send-btn"
                                    class="bg-green-600 text-white font-bold px-1 py-2 rounded-md hover:bg-green-700 transition"
                                    disabled>送信</button>
                            </div>
                            <div id="file-status" class="text-sm text-yellow-300 mt-2 min-h-[20px]"></div>
                        </div>
                    </div>
                    <div id="active-lobby-users" class="border-t border-gray-300 mt-4 pt-4">
                        <h3 class="text-lg font-semibold text-white mb-2">待合室待機者</h3>
                        <div id="lobby-user-count" class="text-sm text-white mb-2">人数: 読み込み中...</div>
                        <ul id="lobby-user-list" class="pl-0 text-white text-sm"></ul>
                    </div>
                </div>
                <div id="emoticon-reaction-field"
                    class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white font-extrabold z-100 whitespace-nowrap">
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル (ダイアログ) -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-2">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl md:p-6 p-2 md:max-w-md max-w-sm w-full">
            <h3 id="modal-title" class="md:text-2xl text-lg text-black font-bold mb-4"></h3>
            <p id="modal-body" class="text-gray-700 mb-6 md:text-base text-sm"></p>
            <div id="modal-buttons" class="flex justify-center space-x-3">
                <!-- ボタンがここに入る -->
            </div>
        </div>
    </div>
</body>

</html>